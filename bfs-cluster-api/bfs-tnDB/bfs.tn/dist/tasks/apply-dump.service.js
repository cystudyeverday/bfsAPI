const a42_0x3e8c=['Md5Repository','AgfidRepository','/1.txt','subDays','agfs_','../repositories/sha1.repository','error','defineProperty','length','../repositories/hourImport.respository','../config','../repositories/agfid.repository','applyHourly','*/10\x20*\x20*\x20*\x20*','md5_','getOwnPropertyDescriptor','asc','afid','pluck','metadata','afidRepository','dayImportRepository','tnodeRepository','/etn/pnodes','md5Repository','transaction','Injectable','isArray','format','startsWith','prototype','decorate','patchAgfids','lite','apply\x20dump\x20from\x20','afs_arfs_','updateTime','propertyIsEnumerable','hasOwnProperty','select','object','../mysql/mysql.module','patchAfids','../lib/log','onTick','agfid','downloadDump','getOneByCluster','call','date','assign','update','upsert','hour','catch','handlePatch','createLogger','function','patchMd5s','getOwnPropertySymbols','dateFormat','AfidRepository','sha1Repository','design:returntype','applyDaily','agfidRepository','info','hex2Buffer','buffer2Hex','design:type','HourImportRepository','md5','message','DayImportRepository','data','../repositories/afid.repository','mysql','Sha1Repository','del','get','design:paramtypes','orderBy','@nestjs/common','commit','thisCluster','patchSha1s','../repositories/tnode.repository','rollback','../repositories/md5.repository','agfid_','where','hourImportRespository','wrong\x20patch\x20','finished','TnodeRepository','indexOf','distinct'];(function(_0x2460c8,_0x3e8cfb){const _0x4ba7d6=function(_0x56de98){while(--_0x56de98){_0x2460c8['push'](_0x2460c8['shift']());}};_0x4ba7d6(++_0x3e8cfb);}(a42_0x3e8c,0xfc));const a42_0x4ba7=function(_0x2460c8,_0x3e8cfb){_0x2460c8=_0x2460c8-0x0;let _0x4ba7d6=a42_0x3e8c[_0x2460c8];return _0x4ba7d6;};'use strict';var __decorate=this&&this['__decorate']||function(_0x1e862b,_0x25ac1d,_0x145109,_0x436afe){var _0x665c1d=arguments[a42_0x4ba7('0x2f')],_0x478a8a=_0x665c1d<0x3?_0x25ac1d:_0x436afe===null?_0x436afe=Object[a42_0x4ba7('0x36')](_0x25ac1d,_0x145109):_0x436afe,_0x130ca1;if(typeof Reflect==='object'&&typeof Reflect['decorate']==='function')_0x478a8a=Reflect[a42_0x4ba7('0x46')](_0x1e862b,_0x25ac1d,_0x145109,_0x436afe);else for(var _0x513e8b=_0x1e862b[a42_0x4ba7('0x2f')]-0x1;_0x513e8b>=0x0;_0x513e8b--)if(_0x130ca1=_0x1e862b[_0x513e8b])_0x478a8a=(_0x665c1d<0x3?_0x130ca1(_0x478a8a):_0x665c1d>0x3?_0x130ca1(_0x25ac1d,_0x145109,_0x478a8a):_0x130ca1(_0x25ac1d,_0x145109))||_0x478a8a;return _0x665c1d>0x3&&_0x478a8a&&Object['defineProperty'](_0x25ac1d,_0x145109,_0x478a8a),_0x478a8a;};var __metadata=this&&this['__metadata']||function(_0x4d463f,_0x60633c){if(typeof Reflect===a42_0x4ba7('0x4f')&&typeof Reflect[a42_0x4ba7('0x3a')]===a42_0x4ba7('0x60'))return Reflect[a42_0x4ba7('0x3a')](_0x4d463f,_0x60633c);};var __rest=this&&this['__rest']||function(_0x37cd6a,_0x71d80b){var _0x3300a3={};for(var _0x15e149 in _0x37cd6a)if(Object[a42_0x4ba7('0x45')][a42_0x4ba7('0x4d')][a42_0x4ba7('0x57')](_0x37cd6a,_0x15e149)&&_0x71d80b['indexOf'](_0x15e149)<0x0)_0x3300a3[_0x15e149]=_0x37cd6a[_0x15e149];if(_0x37cd6a!=null&&typeof Object[a42_0x4ba7('0x1')]===a42_0x4ba7('0x60'))for(var _0x4ea0c2=0x0,_0x15e149=Object[a42_0x4ba7('0x1')](_0x37cd6a);_0x4ea0c2<_0x15e149[a42_0x4ba7('0x2f')];_0x4ea0c2++){if(_0x71d80b[a42_0x4ba7('0x25')](_0x15e149[_0x4ea0c2])<0x0&&Object[a42_0x4ba7('0x45')][a42_0x4ba7('0x4c')][a42_0x4ba7('0x57')](_0x37cd6a,_0x15e149[_0x4ea0c2]))_0x3300a3[_0x15e149[_0x4ea0c2]]=_0x37cd6a[_0x15e149[_0x4ea0c2]];}return _0x3300a3;};Object[a42_0x4ba7('0x2e')](exports,'__esModule',{'value':!![]});const common_1=require(a42_0x4ba7('0x18'));const schedule_1=require('@nestjs/schedule');const axios_1=require('axios');const date_fns_1=require('date-fns');const config_1=require(a42_0x4ba7('0x31'));const log_1=require(a42_0x4ba7('0x52'));const utils_1=require('../lib/utils');const mysql_module_1=require(a42_0x4ba7('0x50'));const afid_repository_1=require(a42_0x4ba7('0x11'));const agfid_repository_1=require(a42_0x4ba7('0x32'));const dayImport_repository_1=require('../repositories/dayImport.repository');const hourImport_respository_1=require(a42_0x4ba7('0x30'));const md5_repository_1=require(a42_0x4ba7('0x1e'));const sha1_repository_1=require(a42_0x4ba7('0x2c'));const tnode_repository_1=require(a42_0x4ba7('0x1c'));const logger=log_1[a42_0x4ba7('0x5f')](__filename);let ApplyDumpService=class ApplyDumpService{constructor(_0x263b4b,_0x58e05a,_0x18903d,_0x371968,_0x4cd8e6,_0x52a5c4,_0x82e23e){this[a42_0x4ba7('0x3b')]=_0x263b4b;this['agfidRepository']=_0x58e05a;this['hourImportRespository']=_0x18903d;this[a42_0x4ba7('0x3c')]=_0x371968;this[a42_0x4ba7('0x3f')]=_0x4cd8e6;this[a42_0x4ba7('0x4')]=_0x52a5c4;this[a42_0x4ba7('0x3d')]=_0x82e23e;}async[a42_0x4ba7('0x55')](_0x5da612,_0x31c37d){const {data}=await _0x5da612[a42_0x4ba7('0x15')]('/'+utils_1[a42_0x4ba7('0xa')](_0x31c37d)+a42_0x4ba7('0x29'));let _0x8d84b;try{_0x8d84b=JSON['parse'](data);}catch(_0x77bea1){_0x8d84b=data;}return _0x8d84b;}async[a42_0x4ba7('0x51')](_0x5de1d5,_0x51312a,_0x32e101){for(let _0x3ca83f of _0x32e101){const {afid,updateTime,mini,lite}=_0x3ca83f,_0x4e5540=__rest(_0x3ca83f,[a42_0x4ba7('0x38'),a42_0x4ba7('0x4b'),'mini',a42_0x4ba7('0x48')]);await this[a42_0x4ba7('0x3b')]['upsert'](_0x5de1d5,_0x51312a,Object['assign']({'afid':utils_1[a42_0x4ba7('0x9')](afid),'updateTime':new Date(updateTime),'mini':mini?utils_1[a42_0x4ba7('0x9')](mini):null,'lite':lite?utils_1['hex2Buffer'](lite):null},_0x4e5540));}}async[a42_0x4ba7('0x47')](_0x2faa0f,_0x3544e4,_0x1da258){for(let _0x36014b of _0x1da258){const {agfid,updateTime}=_0x36014b,_0x4aa5d6=__rest(_0x36014b,[a42_0x4ba7('0x54'),a42_0x4ba7('0x4b')]);await this[a42_0x4ba7('0x7')][a42_0x4ba7('0x5b')](_0x2faa0f,_0x3544e4,Object[a42_0x4ba7('0x59')]({'agfid':utils_1[a42_0x4ba7('0x9')](agfid),'updateTime':new Date(updateTime)},_0x4aa5d6));}}async[a42_0x4ba7('0x0')](_0x15aa83,_0x3c3ab6,_0x4d701c){for(let _0x5d46be of _0x4d701c){const {md5,afid,updateTime}=_0x5d46be,_0x5ce1ed=__rest(_0x5d46be,[a42_0x4ba7('0xd'),a42_0x4ba7('0x38'),a42_0x4ba7('0x4b')]);await this[a42_0x4ba7('0x3f')][a42_0x4ba7('0x5b')](_0x15aa83,_0x3c3ab6,Object[a42_0x4ba7('0x59')]({'md5':utils_1[a42_0x4ba7('0x9')](md5),'afid':utils_1[a42_0x4ba7('0x9')](afid),'updateTime':new Date(updateTime)},_0x5ce1ed));}}async[a42_0x4ba7('0x1b')](_0x2ce0de,_0xf4dbe8,_0x27f9e5){for(let _0x4c051b of _0x27f9e5){const {sha1,afid,updateTime}=_0x4c051b,_0x7e3386=__rest(_0x4c051b,['sha1',a42_0x4ba7('0x38'),a42_0x4ba7('0x4b')]);await this['sha1Repository'][a42_0x4ba7('0x5b')](_0x2ce0de,_0xf4dbe8,Object[a42_0x4ba7('0x59')]({'sha1':utils_1[a42_0x4ba7('0x9')](sha1),'afid':utils_1[a42_0x4ba7('0x9')](afid),'updateTime':new Date(updateTime)},_0x7e3386));}}async[a42_0x4ba7('0x5e')](_0x29625c,_0x5d1981,_0x2f83c4){for(const [_0x438b44,_0x118a25]of Object['entries'](_0x2f83c4)){if(_0x438b44['startsWith'](a42_0x4ba7('0x4a'))||_0x438b44[a42_0x4ba7('0x44')]('afid_')){await this[a42_0x4ba7('0x51')](_0x29625c,_0x5d1981,_0x118a25);}else if(_0x438b44[a42_0x4ba7('0x44')](a42_0x4ba7('0x2b'))||_0x438b44[a42_0x4ba7('0x44')](a42_0x4ba7('0x1f'))){await this['patchAgfids'](_0x29625c,_0x5d1981,_0x118a25);}else if(_0x438b44[a42_0x4ba7('0x44')](a42_0x4ba7('0x35'))){await this[a42_0x4ba7('0x0')](_0x29625c,_0x5d1981,_0x118a25);}else if(_0x438b44['startsWith']('sha1_')){await this[a42_0x4ba7('0x1b')](_0x29625c,_0x5d1981,_0x118a25);}}}async[a42_0x4ba7('0x6')](_0x8ce27d,_0x5d7e6c){const _0x4d5e6f=await this[a42_0x4ba7('0x3c')]['tb'](mysql_module_1[a42_0x4ba7('0x12')])[a42_0x4ba7('0x4e')]()[a42_0x4ba7('0x20')]({'cluster':_0x8ce27d})[a42_0x4ba7('0x20')](a42_0x4ba7('0x23'),0x0)[a42_0x4ba7('0x17')]('date',a42_0x4ba7('0x37'));for(const {date,afid}of _0x4d5e6f){logger[a42_0x4ba7('0x8')]('apply\x20dump\x20from\x20'+_0x8ce27d+'\x20'+date);const _0x428611=await this[a42_0x4ba7('0x55')](_0x5d7e6c,afid)[a42_0x4ba7('0x5d')](_0x26cd44=>{logger['error'](_0x26cd44[a42_0x4ba7('0xe')]);});if(!_0x428611){continue;}const _0x28b07a=_0x428611[_0x8ce27d];if(!_0x28b07a){logger[a42_0x4ba7('0x2d')](a42_0x4ba7('0x22')+utils_1[a42_0x4ba7('0xa')](afid));await this[a42_0x4ba7('0x3c')]['tb'](mysql_module_1[a42_0x4ba7('0x12')])[a42_0x4ba7('0x14')]()[a42_0x4ba7('0x20')]({'cluster':_0x8ce27d,'date':date});continue;}const _0x559fa9=await mysql_module_1['mysql'][a42_0x4ba7('0x40')]();try{await this['handlePatch'](_0x559fa9,_0x8ce27d,_0x28b07a);await this['dayImportRepository']['tb'](_0x559fa9)[a42_0x4ba7('0x5a')](a42_0x4ba7('0x23'),0x1)[a42_0x4ba7('0x20')]({'cluster':_0x8ce27d,'date':date});await _0x559fa9[a42_0x4ba7('0x19')]();}catch(_0x3607a1){logger[a42_0x4ba7('0x2d')](_0x3607a1);await _0x559fa9['rollback']();}}}async[a42_0x4ba7('0x33')](_0x14e736,_0x34232d){const [{max}]=await this[a42_0x4ba7('0x3c')]['tb'](mysql_module_1[a42_0x4ba7('0x12')])['max']('date')['where']({'cluster':_0x14e736})[a42_0x4ba7('0x20')](a42_0x4ba7('0x23'),0x1);const _0x52e00a=max||date_fns_1[a42_0x4ba7('0x43')](date_fns_1[a42_0x4ba7('0x2a')](new Date(),0x1),config_1[a42_0x4ba7('0x2')]);const _0x3f25a7=await this[a42_0x4ba7('0x21')]['tb'](mysql_module_1['mysql'])['select']('afid',a42_0x4ba7('0x58'),a42_0x4ba7('0x5c'))['where']({'cluster':_0x14e736})[a42_0x4ba7('0x20')](a42_0x4ba7('0x23'),0x0)['where'](a42_0x4ba7('0x58'),'>',_0x52e00a)[a42_0x4ba7('0x17')]([a42_0x4ba7('0x58'),'hour']);for(const {date,hour,afid}of _0x3f25a7){logger[a42_0x4ba7('0x8')](a42_0x4ba7('0x49')+_0x14e736+'\x20'+date+'\x20'+hour);const _0x3ca3fe=await this[a42_0x4ba7('0x55')](_0x34232d,afid)[a42_0x4ba7('0x5d')](_0x5a2306=>{logger['error'](_0x5a2306[a42_0x4ba7('0xe')]);});if(!_0x3ca3fe){continue;}const _0x11bf41=_0x3ca3fe[_0x14e736];if(!_0x11bf41){logger[a42_0x4ba7('0x2d')](a42_0x4ba7('0x22')+utils_1[a42_0x4ba7('0xa')](afid));await this['hourImportRespository']['tb'](mysql_module_1[a42_0x4ba7('0x12')])['del']()[a42_0x4ba7('0x20')]({'cluster':_0x14e736,'date':date,'hour':hour});continue;}const _0x121938=await mysql_module_1[a42_0x4ba7('0x12')][a42_0x4ba7('0x40')]();try{await this[a42_0x4ba7('0x5e')](_0x121938,_0x14e736,_0x11bf41);await this['hourImportRespository']['tb'](_0x121938)['update'](a42_0x4ba7('0x23'),0x1)['where']({'cluster':_0x14e736,'date':date,'hour':hour});await _0x121938['commit']();}catch(_0x32627a){logger[a42_0x4ba7('0x2d')](_0x32627a);await _0x121938[a42_0x4ba7('0x1d')]();}}}async[a42_0x4ba7('0x53')](){const _0x4ff546=await this['hourImportRespository']['tb'](mysql_module_1['mysql'])[a42_0x4ba7('0x26')]('cluster')[a42_0x4ba7('0x39')]('cluster');for(const _0x29a6d6 of _0x4ff546){if(_0x29a6d6===config_1[a42_0x4ba7('0x1a')]){continue;}const {url:_0x160f66}=await this[a42_0x4ba7('0x3d')][a42_0x4ba7('0x56')](_0x29a6d6);const _0xe0fa31=await axios_1['default']['get'](a42_0x4ba7('0x3e'),{'baseURL':_0x160f66,'timeout':0x2710})['catch'](_0x204e88=>{logger[a42_0x4ba7('0x2d')](_0x204e88);});if(!_0xe0fa31||!Array[a42_0x4ba7('0x42')](_0xe0fa31[a42_0x4ba7('0x10')]['data'])||_0xe0fa31[a42_0x4ba7('0x10')][a42_0x4ba7('0x10')][a42_0x4ba7('0x2f')]===0x0){continue;}const _0x35d8f7=axios_1['default']['create']({'baseURL':_0xe0fa31[a42_0x4ba7('0x10')][a42_0x4ba7('0x10')][0x0],'timeout':0x2710});try{await this[a42_0x4ba7('0x6')](_0x29a6d6,_0x35d8f7);await this['applyHourly'](_0x29a6d6,_0x35d8f7);}catch(_0x16fa4f){logger[a42_0x4ba7('0x2d')](_0x16fa4f);}}}};__decorate([schedule_1['Cron'](a42_0x4ba7('0x34')),__metadata(a42_0x4ba7('0xb'),Function),__metadata(a42_0x4ba7('0x16'),[]),__metadata(a42_0x4ba7('0x5'),Promise)],ApplyDumpService[a42_0x4ba7('0x45')],a42_0x4ba7('0x53'),null);ApplyDumpService=__decorate([common_1[a42_0x4ba7('0x41')](),__metadata(a42_0x4ba7('0x16'),[afid_repository_1[a42_0x4ba7('0x3')],agfid_repository_1[a42_0x4ba7('0x28')],hourImport_respository_1[a42_0x4ba7('0xc')],dayImport_repository_1[a42_0x4ba7('0xf')],md5_repository_1[a42_0x4ba7('0x27')],sha1_repository_1[a42_0x4ba7('0x13')],tnode_repository_1[a42_0x4ba7('0x24')]])],ApplyDumpService);exports['ApplyDumpService']=ApplyDumpService;