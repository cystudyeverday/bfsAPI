const a47_0x5ef3=['rollback','info2Obj','AgfidRepository','handleExpired','Injectable','mongoClient','onTick','__esModule','path','string','dateFormat','parse\x20text\x20from\x20rnid:\x20','status','resolve','__decorate','last-modified','agfidRepository','hashService','upsert','collection','info','.expired','HashService','message','utf8','response','error','design:type','defineProperty','design:returntype','axios','line2Obj','length','fieldHandler','__metadata','updated','/text/afidInfo/','commit','../repositories/agfid.repository','statSync','replace','/text/fafid/','ParseTextService','updateHash','rnodeRepository','function','mongoUpdateOne','slice','subDays','date-fns','object','utimesSync','prototype','default','design:paramtypes','createLogger','handleNewInfo','handleAfid','deleteOne','mysql','toUTCString','includes','afidRepository','../services/hash.service','get','../lib/log','transaction','decorate','RnodeRepository','../lib/utils','ensureFileSync','ensureDirSync','indexOf','../config','handleAgfid','linebreakRegex','thisCluster','existsSync','catch','@nestjs/schedule','outputFileSync','cacheDir','Cron','format','mongoDeleteOne','getOwnPropertyDescriptor','metadata','create','finish\x20rnid:\x20','split','created','hex2Buffer'];(function(_0x25f575,_0x5ef34d){const _0x525a3b=function(_0x34020f){while(--_0x34020f){_0x25f575['push'](_0x25f575['shift']());}};_0x525a3b(++_0x5ef34d);}(a47_0x5ef3,0x103));const a47_0x525a=function(_0x25f575,_0x5ef34d){_0x25f575=_0x25f575-0x0;let _0x525a3b=a47_0x5ef3[_0x25f575];return _0x525a3b;};'use strict';var __decorate=this&&this[a47_0x525a('0x1f')]||function(_0x55c957,_0x25f858,_0x20e5fa,_0x16d152){var _0x57d728=arguments[a47_0x525a('0x31')],_0x4f062e=_0x57d728<0x3?_0x25f858:_0x16d152===null?_0x16d152=Object[a47_0x525a('0xa')](_0x25f858,_0x20e5fa):_0x16d152,_0x4642ba;if(typeof Reflect===a47_0x525a('0x43')&&typeof Reflect[a47_0x525a('0x54')]===a47_0x525a('0x3e'))_0x4f062e=Reflect[a47_0x525a('0x54')](_0x55c957,_0x25f858,_0x20e5fa,_0x16d152);else for(var _0x32f433=_0x55c957['length']-0x1;_0x32f433>=0x0;_0x32f433--)if(_0x4642ba=_0x55c957[_0x32f433])_0x4f062e=(_0x57d728<0x3?_0x4642ba(_0x4f062e):_0x57d728>0x3?_0x4642ba(_0x25f858,_0x20e5fa,_0x4f062e):_0x4642ba(_0x25f858,_0x20e5fa))||_0x4f062e;return _0x57d728>0x3&&_0x4f062e&&Object['defineProperty'](_0x25f858,_0x20e5fa,_0x4f062e),_0x4f062e;};var __metadata=this&&this[a47_0x525a('0x33')]||function(_0x13b4ae,_0x286e50){if(typeof Reflect===a47_0x525a('0x43')&&typeof Reflect[a47_0x525a('0xb')]===a47_0x525a('0x3e'))return Reflect['metadata'](_0x13b4ae,_0x286e50);};Object[a47_0x525a('0x2d')](exports,a47_0x525a('0x18'),{'value':!![]});const common_1=require('@nestjs/common');const schedule_1=require(a47_0x525a('0x4'));const axios_1=require(a47_0x525a('0x2f'));const date_fns_1=require(a47_0x525a('0x42'));const fs=require('fs-extra');const path=require(a47_0x525a('0x19'));const config_1=require(a47_0x525a('0x5a'));const log_1=require(a47_0x525a('0x52'));const utils_1=require(a47_0x525a('0x56'));const mongo_module_1=require('../mongo/mongo.module');const mysql_module_1=require('../mysql/mysql.module');const afid_repository_1=require('../repositories/afid.repository');const agfid_repository_1=require(a47_0x525a('0x37'));const rnode_repository_1=require('../repositories/rnode.repository');const hash_service_1=require(a47_0x525a('0x50'));const logger=log_1[a47_0x525a('0x48')](__filename);let ParseTextService=class ParseTextService{constructor(_0x51898f,_0x48dd9d,_0x3e72ff,_0x451eb3){this[a47_0x525a('0x4f')]=_0x51898f;this[a47_0x525a('0x21')]=_0x48dd9d;this[a47_0x525a('0x22')]=_0x3e72ff;this[a47_0x525a('0x3d')]=_0x451eb3;this[a47_0x525a('0x32')]={'afs':async(..._0x1831c7)=>{return this['handleAfid'](..._0x1831c7);},'arfs':async(..._0x2f4944)=>{return this[a47_0x525a('0x4a')](..._0x2f4944);},'agfs':async(..._0x3b4224)=>{return this['handleAgfid'](..._0x3b4224);}};}async[a47_0x525a('0x3f')](_0x22e1c9,_0x1e4540,_0x51c96f,_0x1b0522,_0x14bf41){if(_0x1b0522[a47_0x525a('0x59')]('=')<0x0){logger['error'](_0x1b0522);return;}await mongo_module_1[a47_0x525a('0x16')]['db'](_0x22e1c9)[a47_0x525a('0x24')](_0x1e4540)['updateOne'](_0x14bf41,{'$set':utils_1[a47_0x525a('0x12')](_0x1b0522),'$addToSet':{'rnids':_0x51c96f}},{'upsert':!![]});}async[a47_0x525a('0x9')](_0x2282ff,_0x285814,_0x4abeaf){await mongo_module_1[a47_0x525a('0x16')]['db'](_0x2282ff)[a47_0x525a('0x24')](_0x285814)[a47_0x525a('0x4b')](_0x4abeaf);}async[a47_0x525a('0x4a')](_0x5a9aee,_0x2df151,_0x42da5b,_0x725513,_0x543beb,_0x3d2413){const {afid}=_0x543beb;if(!afid){return;}await this[a47_0x525a('0x4f')][a47_0x525a('0x23')](_0x2df151,config_1['thisCluster'],{'afid':utils_1[a47_0x525a('0x10')](afid),[_0x42da5b]:_0x3d2413,'mini':utils_1[a47_0x525a('0x10')](afid[a47_0x525a('0x40')](0x0,0x4)+afid[a47_0x525a('0x40')](-0x14)),'lite':utils_1[a47_0x525a('0x10')](afid[a47_0x525a('0x40')](0x0,0x10)+afid[a47_0x525a('0x40')](-0x28))});if(_0x3d2413){const {data}=await _0x5a9aee[a47_0x525a('0x51')](a47_0x525a('0x35')+_0x42da5b+'/'+afid);await this[a47_0x525a('0x3f')](_0x42da5b,utils_1['getPostfix'](afid),_0x725513,data,{'afid':afid});}else{await this[a47_0x525a('0x9')](_0x42da5b,utils_1['getPostfix'](afid),{'afid':afid});}await this['hashService'][a47_0x525a('0x3c')](_0x2df151,afid);}async[a47_0x525a('0x5b')](_0x17c86c,_0x2355ff,_0x56b893,_0x9ee39c,_0x4cbbf4,_0x424bbf){const {agfid}=_0x4cbbf4;if(!agfid){return;}await this[a47_0x525a('0x21')][a47_0x525a('0x23')](_0x2355ff,config_1[a47_0x525a('0x1')],{'agfid':utils_1['hex2Buffer'](agfid),[_0x56b893]:_0x424bbf});if(_0x424bbf){const {data}=await _0x17c86c[a47_0x525a('0x51')](a47_0x525a('0x35')+_0x56b893+'/'+agfid);await this[a47_0x525a('0x3f')](_0x56b893,utils_1['getPostfix'](agfid),_0x9ee39c,data,{'agfid':agfid});}else{await this[a47_0x525a('0x9')](_0x56b893,utils_1['getPostfix'](agfid),{'agfid':agfid});}}async[a47_0x525a('0x14')](_0x4a3c71,_0x184e32,_0xd33a37,_0x1dfb4f){const _0x2702a4=path[a47_0x525a('0x1e')](config_1[a47_0x525a('0x6')],_0x1dfb4f);fs[a47_0x525a('0x58')](_0x2702a4);const _0x3d9e2c=path[a47_0x525a('0x1e')](_0x2702a4,_0xd33a37+'.'+_0x184e32+a47_0x525a('0x26'));if(fs[a47_0x525a('0x2')](_0x3d9e2c)){return;}const _0xaa24f9=await _0x4a3c71['get'](a47_0x525a('0x3a')+_0x184e32+'/'+_0xd33a37+'/expired')[a47_0x525a('0x3')](_0x1c16b7=>_0x1c16b7['response']?_0x1c16b7[a47_0x525a('0x2a')]:logger[a47_0x525a('0x2b')](_0x1c16b7[a47_0x525a('0x28')]));if(!_0xaa24f9){return;}const {data}=_0xaa24f9;if(typeof data===a47_0x525a('0x1a')){const _0x420489=data[a47_0x525a('0xe')](config_1[a47_0x525a('0x0')]);const _0x2c0a2d=await mysql_module_1[a47_0x525a('0x4c')][a47_0x525a('0x53')]();try{for(const _0x4028ab of _0x420489){const _0x521642=utils_1[a47_0x525a('0x30')](_0x4028ab);await this['fieldHandler'][_0x184e32](_0x4a3c71,_0x2c0a2d,_0x184e32,_0x1dfb4f,_0x521642,0x0);}await _0x2c0a2d[a47_0x525a('0x36')]();fs['ensureFileSync'](_0x3d9e2c);}catch(_0x58b026){await _0x2c0a2d[a47_0x525a('0x11')]();logger[a47_0x525a('0x2b')](_0x58b026);}}else if(typeof data===a47_0x525a('0x43')){if(data['code']===0x9c41){fs[a47_0x525a('0x57')](_0x3d9e2c);}else{logger[a47_0x525a('0x2b')](data);}}else{logger[a47_0x525a('0x2b')](data);}}async[a47_0x525a('0x49')](_0x30f9e9,_0xebcf68,_0x5c6af6,_0x4d806a){const _0x1786a7=[a47_0x525a('0xf'),a47_0x525a('0x34')];const _0x425f4c=path[a47_0x525a('0x1e')](config_1[a47_0x525a('0x6')],_0x4d806a);fs[a47_0x525a('0x58')](_0x425f4c);for(const _0x5417ff of _0x1786a7){const _0x1f273a=path[a47_0x525a('0x1e')](_0x425f4c,_0x5c6af6+'.'+_0xebcf68+'.'+_0x5417ff+'.txt');if(!fs[a47_0x525a('0x2')](_0x1f273a)){fs['ensureFileSync'](_0x1f273a);const _0x309402=date_fns_1['subDays'](new Date(),0x1);fs[a47_0x525a('0x44')](_0x1f273a,_0x309402,_0x309402);}const {mtime}=fs[a47_0x525a('0x38')](_0x1f273a);const _0x162c99=await _0x30f9e9[a47_0x525a('0x51')](a47_0x525a('0x3a')+_0xebcf68+'/'+_0x5c6af6+'/'+_0x5417ff,{'headers':{'If-Modified-Since':mtime[a47_0x525a('0x4d')]()}})[a47_0x525a('0x3')](_0x1b6101=>{if(!_0x1b6101[a47_0x525a('0x2a')]||![0x130,0x194][a47_0x525a('0x4e')](_0x1b6101[a47_0x525a('0x2a')][a47_0x525a('0x1d')])){logger[a47_0x525a('0x2b')](_0x1b6101[a47_0x525a('0x28')]);}});if(!_0x162c99){continue;}const {headers,data}=_0x162c99;const _0x196ff3=fs['readFileSync'](_0x1f273a,a47_0x525a('0x29'));const _0x306832=data[a47_0x525a('0x39')](_0x196ff3,'');const _0x29fea1=_0x306832[a47_0x525a('0xe')](config_1['linebreakRegex']);const _0x1bac4b=await mysql_module_1['mysql'][a47_0x525a('0x53')]();try{for(const _0x2d7ae8 of _0x29fea1){const _0x14fb2d=utils_1['line2Obj'](_0x2d7ae8);await this[a47_0x525a('0x32')][_0xebcf68](_0x30f9e9,_0x1bac4b,_0xebcf68,_0x4d806a,_0x14fb2d,0x1);}await _0x1bac4b[a47_0x525a('0x36')]();const _0x49d4de=new Date(headers[a47_0x525a('0x20')]);fs[a47_0x525a('0x5')](_0x1f273a,data);fs[a47_0x525a('0x44')](_0x1f273a,_0x49d4de,_0x49d4de);}catch(_0x2da127){await _0x1bac4b[a47_0x525a('0x11')]();logger[a47_0x525a('0x2b')](_0x2da127);}}}async['onTick'](){const _0x220699=new Date();const _0x123036=date_fns_1[a47_0x525a('0x8')](date_fns_1['subMinutes'](_0x220699,0x15),config_1['dateFormat']);const _0x5b83a6=date_fns_1[a47_0x525a('0x8')](date_fns_1[a47_0x525a('0x41')](_0x220699,0x1),config_1[a47_0x525a('0x1b')]);const _0xc49b2=await this[a47_0x525a('0x3d')]['getAll']();for(const {rnid,url}of _0xc49b2){logger[a47_0x525a('0x25')](a47_0x525a('0x1c')+rnid);const _0xe319e9=axios_1[a47_0x525a('0x46')][a47_0x525a('0xc')]({'baseURL':url,'timeout':0x2710});for(const _0x1c6fc3 of config_1['fields']){try{await this['handleExpired'](_0xe319e9,_0x1c6fc3,_0x5b83a6,rnid);await this[a47_0x525a('0x49')](_0xe319e9,_0x1c6fc3,_0x123036,rnid);}catch(_0x557ba4){logger['error'](_0x557ba4[a47_0x525a('0x28')]);}}logger['info'](a47_0x525a('0xd')+rnid);}}};__decorate([schedule_1[a47_0x525a('0x7')]('*/10\x20*\x20*\x20*\x20*'),__metadata(a47_0x525a('0x2c'),Function),__metadata(a47_0x525a('0x47'),[]),__metadata(a47_0x525a('0x2e'),Promise)],ParseTextService[a47_0x525a('0x45')],a47_0x525a('0x17'),null);ParseTextService=__decorate([common_1[a47_0x525a('0x15')](),__metadata('design:paramtypes',[afid_repository_1['AfidRepository'],agfid_repository_1[a47_0x525a('0x13')],hash_service_1[a47_0x525a('0x27')],rnode_repository_1[a47_0x525a('0x55')]])],ParseTextService);exports[a47_0x525a('0x3b')]=ParseTextService;